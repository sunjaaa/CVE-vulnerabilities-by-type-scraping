const helper = require("./helper");

const getData = async (CVEwebSite, CVEList, fileName) => {
  {
    for (let num = 2; num <= 100; num = num + 2) {
      //! 한 페이지에서 가져온 데이터
      let pageData = {};

      const descriptionNum = num + 1;

      // 로딩 첫번째 기다리기
      try {
        await CVEwebSite.waitForSelector(
          `#vulnslisttable > tbody > tr:nth-child(
    ${num}
    ) > td:nth-child(1)`
        );
        // 로딩 첫번째 기다리기

        await CVEwebSite.waitForSelector(
          `#vulnslisttable > tbody > tr:nth-child(
    ${num}
    ) > td:nth-child(15)`
        );
        //로딩 기다리기
        await CVEwebSite.waitForSelector(
          `#vulnslisttable > tbody > tr:nth-child(${num + 1}) > td`
        );
      } catch (e) {
        throw e;
      }

      try {
        pageData.category = fileName;
        console.log(" fileNameoooo", fileName);
      } catch (e) {
        pageData.category = "";
      }

      try {
        const number = await CVEwebSite.$eval(
          `#vulnslisttable > tbody > tr:nth-child(
            ${num}
            ) > td:nth-child(1)`,
          (el) => el.textContent
        );
        pageData.number = helper.removeNewLine(number);
      } catch (e) {
        console.error("번호가 존재하지 않습니다.", e);
        throw e;
      }

      try {
        const cveID = await CVEwebSite.$eval(
          `#vulnslisttable > tbody > tr:nth-child(${num}) > td:nth-child(2) > a`,
          (el) => el.textContent
        );
        pageData.cveID = cveID;
      } catch (e) {
        console.error("crawler.js cveID", e);
        throw e;
      }

      try {
        const cweID = await CVEwebSite.$eval(
          `#vulnslisttable > tbody > tr:nth-child(${num}) > td:nth-child(3) > a`,
          (el) => el.textContent
        );
        pageData.cweID = cweID;
      } catch (e) {
        pageData.cweID = "";
      }

      try {
        const _ofExploits = await CVEwebSite.$eval(
          `#vulnslisttable > tbody > tr:nth-child(${num}) > td:nth-child(4) > a`,
          (el) => el.textContent
        );
        pageData._ofExploits = _ofExploits;
      } catch (e) {
        pageData._ofExploits = "";
      }

      try {
        const vulnerabilityTypes = await CVEwebSite.$eval(
          `#vulnslisttable > tbody > tr:nth-child(${num}) > td:nth-child(5)`,
          (el) => el.textContent
        );
        pageData.vulnerabilityTypes = helper.removePlus(vulnerabilityTypes);
      } catch (e) {
        pageData.vulnerabilityTypes = "";
      }

      try {
        const publishDate = await CVEwebSite.$eval(
          `#vulnslisttable > tbody > tr:nth-child(${num}) > td:nth-child(6)`,
          (el) => el.textContent
        );
        pageData.publishDate = publishDate;
      } catch (e) {
        pageData.publishDate = "";
      }

      try {
        const updateDate = await CVEwebSite.$eval(
          `#vulnslisttable > tbody > tr:nth-child(${num}) > td:nth-child(7)`,
          (el) => el.textContent
        );
        pageData.updateDate = updateDate;
      } catch (e) {
        pageData.updateDate = "";
      }

      try {
        const score = await CVEwebSite.$eval(
          `#vulnslisttable > tbody > tr:nth-child(${num}) > td:nth-child(8) > div`,
          (el) => el.textContent
        );
        pageData.score = score;
      } catch (e) {
        pageData.score = "";
      }

      try {
        const gainedAccessLevel = await CVEwebSite.$eval(
          `#vulnslisttable > tbody > tr:nth-child(${num}) > td:nth-child(9)`,
          (el) => el.textContent
        );
        pageData.gainedAccessLevel = gainedAccessLevel;
      } catch (e) {
        pageData.gainedAccessLevel = "";
      }

      try {
        const access = await CVEwebSite.$eval(
          `#vulnslisttable > tbody > tr:nth-child(${num}) > td:nth-child(10)`,
          (el) => el.textContent
        );
        pageData.access = access;
      } catch (e) {
        pageData.access = "";
      }

      try {
        const complexity = await CVEwebSite.$eval(
          `#vulnslisttable > tbody > tr:nth-child(${num}) > td:nth-child(11)`,
          (el) => el.textContent
        );
        pageData.complexity = complexity;
      } catch (e) {
        pageData.complexity = "";
      }

      try {
        const authentication = await CVEwebSite.$eval(
          `#vulnslisttable > tbody > tr:nth-child(${num}) > td:nth-child(12)`,
          (el) => el.textContent
        );
        pageData.authentication = authentication;
      } catch (e) {
        pageData.authentication = "";
      }

      try {
        const conf = await CVEwebSite.$eval(
          `#vulnslisttable > tbody > tr:nth-child(${num}) > td:nth-child(13)`,
          (el) => el.textContent
        );
        pageData.conf = conf;
      } catch (e) {
        pageData.conf = "";
      }

      try {
        const integ = await CVEwebSite.$eval(
          `#vulnslisttable > tbody > tr:nth-child(${num}) > td:nth-child(14)`,
          (el) => el.textContent
        );
        pageData.integ = integ;
      } catch (e) {
        pageData.integ = "";
      }

      try {
        const avail = await CVEwebSite.$eval(
          `#vulnslisttable > tbody > tr:nth-child(${num}) > td:nth-child(15)`,
          (el) => el.textContent
        );
        pageData.avail = avail;
      } catch (e) {
        pageData.avail = "";
      }

      try {
        const description = await CVEwebSite.$eval(
          `#vulnslisttable > tbody > tr:nth-child(${descriptionNum}) > td`,
          (el) => el.textContent
        );

        pageData.description = helper.removeCommaWithNewLines(description);
      } catch (e) {
        pageData.description = "";
      }

      CVEList.push(pageData);
      console.log("********PUSHED********");
    }
  }
};

exports.getData = getData;
